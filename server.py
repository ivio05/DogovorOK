from flask import Flask, request, jsonify
from flask_cors import CORS
import os
import tempfile
from werkzeug.utils import secure_filename
import time

from model_funcs import check_contract

app = Flask(__name__)
CORS(app, resources={r"/*": {"origins": "*"}})  # Полное разрешение CORS

# Используем временную папку системы
UPLOAD_FOLDER = tempfile.gettempdir() + '/contract_uploads'
ALLOWED_EXTENSIONS = {'txt', 'pdf', 'docx'}

os.makedirs(UPLOAD_FOLDER, exist_ok=True)

def allowed_file(filename):
    return '.' in filename and filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

@app.route('/analyze', methods=['POST'])
def analyze():
    # Проверяем наличие файла в памяти
    if 'file' not in request.files:
        return jsonify({"status": "error", "message": "No file"}), 400
        
    file = request.files['file']
    if file.filename == '':
        return jsonify({"status": "error", "message": "Empty filename"}), 400

    if not allowed_file(file.filename):
        return jsonify({"status": "error", "message": "Invalid file type"}), 400

    try:
        # Создаем временный файл
        filename = secure_filename(file.filename)
        temp_path = os.path.join(UPLOAD_FOLDER, filename)
        
        # Сохраняем и сразу закрываем файл
        with open(temp_path, 'wb') as f:
            file.save(f)

        result = check_contract(temp_path)
        # print(result)
        legal_score, economic_score, legalFactors, economicFactors = result

        final = "<h2>Юридические факторы:</h2>"

        for q, r in legalFactors.items():
            if q == 'Не является ли документ лицензионным соглашением?':
                if r == True:
                    final += '<br>+: Документ не является лицензионным соглашением'
                    final += "<br>"
                else: 
                    final += '<br>-: Документ является лицензионным соглашением'
                    final += "<br>Договор франшизы в отличие от лицензионного договора дает возможность использовать не один определенный объект интеллектуальной собственности, а комплекс объектов исключительных прав<br>"
            elif q == 'Отсутствует ли одностороннее расторжение без объяснения причин?':
                if r == True:
                    final += '<br>+: Правообладатель не вправе расторгнуть договор без объяснения причин'
                    final += "<br>"
                else:
                    final += '<br>-: Правообладатель вправе расторгнуть договор без объяснения причин'
                    final += '''<br>Если в договоре предусмотрено право на отказ, то оно может быть реализовано по-разному, если это не запрещено законом (п. 4 ст. 421 ГК РФ): отказ может быть мотивированным - связанным с нарушением договора контрагента или немотивированным - при котором отказаться от исполнения договора можно в любое время без объяснения причин
                        Вы можете включить следующие условия, касающиеся одностороннего отказа сторон от договора (п. 1 ст. 1037 ГК РФ):
                        для срочного - возможность досрочно отказаться от него путем уплаты отступного (п. 1.1 ст. 1037 ГК РФ);
                        для бессрочного - возможность предусмотреть более продолжительный, чем шесть месяцев, срок для уведомления другой стороны об отказе от договора. Кроме того, и для такого договора работает вариант с условием о возможности отказаться от него путем уплаты отступного. В этом случае уведомить другую сторону об отказе нужно всего лишь за 30 дней.
                        <br>'''
            elif q == 'Даются ли Пользователю права на товарный знак?':
                if r == True:
                    final += '<br>+: Пользователю даются права на товарный знак'
                    final += "<br>"
                else:
                    final += '<br>-: Пользователю не даются права на товарный знак'
                    final += "<br>По договору коммерческой концессии правообладатель обязуется предоставить пользователю за вознаграждение на срок или без указания срока право использовать в предпринимательской деятельности пользователя комплекс принадлежащих правообладателю исключительных прав, включающий право на товарный знак, знак обслуживания, а также права на другие предусмотренные договором объекты исключительных прав, в частности на коммерческое обозначение, секрет производства (ноу-хау) (п.1 ст.1027 ГК РФ)<br>"
            elif q == 'Отсутствует ли автоматическое расторжение?':
                if r == True:
                    final += '<br>+: Отсутствует автоматическое расторжение договора'
                    final += "<br>"
                else:
                    final += '<br>-: Присутствует автоматическое расторжение договора'
                    final += "<br>Автоматическое прекращение договора коммерческой концессии возможно в двух случаях, прямо предусмотренных законом.  Во-первых, когда  одну из сторон суд признал банкротом. Во-вторых, истек срок действия исключительного права на товарный знак.<br>"
            elif q == 'Отсутствует ли запрет конкуренции?':
                if r == True:
                    final += '<br>+: Отсутствует запрет конкуренции'
                    final += "<br>"
                else:
                    final += '<br>-: Присутствует запрет конкуренции'
                    final += "<br>Вы можете включить в договор условия, которые ограничивают действия сторон договора. Примерный перечень ограничений есть в п. 1 ст. 1033 ГК РФ.<br>"
            elif q == 'Имееется ли государственная регистрация?':
                if r == True:
                    final += '<br>+: Присутствует государственная регистрация'
                    final += "<br>"
                else:
                    final += '<br>-: Государственная регистрация отсутствует'
                    final += "<br>Обратите внимание, что регистрации подлежит не сам договор коммерческой концессии, а предоставление по нему права использовать комплекс исключительных прав правообладателя в предпринимательской деятельности пользователя. Без регистрации предоставление права использования считается несостоявшимся (п. 2 ст. 1028 ГК РФ).<br>"
            elif q == 'Указан ли размер вознаграждения?':
                if r == True:
                    final += '<br>+: Указан размер вознаграждения'
                    final += "<br>"
                else:
                    final += '<br>-: Не указан размер вознаграждения'
                    final += "<br>Без этого условия договор по общему правилу считается незаключенным (п. п. 1, 4 ст. 1027, п. 5 ст. 1235 ГК РФ).<br>"
            elif q == 'Указан порядок подачи документов?':
                if r == True:
                    final += '<br>+: Указан порядок подачи документов'
                    final += "<br>"
                else:
                    final += '<br>-: Не указан порядок подачи документов?'
                    final += "<br>Регистрацию обеспечивает правообладатель, если договором не предусмотрено иное (п. 2 ст. 1031 ГК РФ). Вместе с тем в регистрации не обязательно откажут, если документы подаст пользователь или, напротив, правообладатель, когда договором такая обязанность возложена на пользователя (п. 3.4.10 Рекомендаций по вопросам проверки договоров о распоряжении исключительным правом). Предоставление права зарегистрируют (или откажут в регистрации, если для этого будут основания) в срок не более 45 рабочих дней со дня, когда необходимые документы поступят в Роспатент. Этот срок в ряде случаев может быть увеличен (п. п. 14, 15 Административного регламента по регистрации распоряжения по договору исключительным правом, п. 17 Правил регистрации распоряжения исключительным правом).<br>"
            elif q == 'Является ли Правообладатель юридическим лицом?':
                if r == True:
                    final += '<br>+: Правообладатель является юридическим лицом'
                    final += "<br>"
                else:
                    final += '<br>-: Правообладатель не является юридическим лицом'
                    final += "<br>Сторонами по договору коммерческой концессии могут быть коммерческие организации и граждане, зарегистрированные в качестве индивидуальных предпринимателей (п.3 ст. 1027 ГК РФ)<br>"
            elif q == 'Указаны ли положения о претензионном порядке?':
                if r == True:
                    final += '<br>+: Указаны положения о претензионном порядке'
                    final += "<br>"
                else:
                    final += '<br>-: Не указаны положения о претензионном порядке'
                    final += '''<br>Если вы не включите условие о претензионном порядке, то на разрешение арбитражного суда можно передать (ч. 5 ст. 4 АПК РФ): 
                        спор о взыскании денежных средств - только по истечении 30 календарных дней со дня направления претензии, если иные срок и (или) порядок не установлены законом; 
                        иные возникшие из договора споры - без соблюдения досудебного порядка, только если такой порядок не установлен федеральным законом.
                        Вы можете указать иные способы направления (https://cloud.consultant.ru/cloud/cgi/online.cgi?req=doc&base=CJI&n=118813&dst=100016&field=134&rnd Zu6paA) юридически значимых сообщений, но рекомендуем выбрать такие, которые позволят доказать факт получения сообщения адресатом.
                        <br>'''
            elif q == 'Указан ли срок действия договора?':
                if r == True:
                    final += '<br>+: Указан срок действия договора'
                    final += "<br>"
                else:
                    final += '<br>-: Не указан срок действия договора'
                    final += "<br>Если вы не укажете срок действия договора, он будет действовать 5 лет (п. 4 ст. 1027, п. 4 ст. 1235 ГК РФ).<br>"
            elif q == 'Указан ли номер свидетельства правообладателя?':
                if r == True:
                    final += '<br>+: Указан номер свидетельства правообладателя'
                    final += "<br>"
                else:
                    final += '<br>-: Не указан номер свидетельства правообладателя'
                    final += "<br>Без указания номера свидетельства правообладателя и перечня товаров, в отношении которых пользователь вправе использовать товарный знак, договор по общему правилу может быть признан незаключенным (п. п. 1, 3 ст. 432, п. 4 ст. 1027, пп. 1 п. 6 ст. 1235, п. 1.1 ст. 1489 ГК РФ). Если какой-то из способов не будет указан в договоре, пользователь не сможет его применять (п. 4 ст. 1027, п. 1 ст. 1235 ГК РФ).<br>"
                    
        final += f'''<br><br>
            <h2>Экономические факторы:</h2>
                <br>Роялти: {economicFactors["Роялти"]}%
                <br>В качестве роялти признают плату за использование долгосрочных активов организации, в частности патентов, торговых марок, авторских прав и компьютерного программного обеспечения. Также роялти определяют как периодические выплаты за использование патента и иных объектов интеллектуальной собственности, выплачиваемые в виде процента от стоимости проданных товаров и услуг, при производстве которых использовались патенты, авторские права и др.
                <br>
                <br>Паушальный взнос: {economicFactors["Паушальный взнос"]} руб.
                <br>Паушальный взнос в нормативных правовых актах РФ определяется как выплата по передаче прав на франшизу.
                <br>
                <br>Максимальный штраф: {economicFactors["Максимальный штраф"]} руб.
                <br>На случай неисполнения или ненадлежащего исполнения обязательства, в частности при просрочке исполнения, законом или договором может быть предусмотрена обязанность должника уплатить кредитору определенную денежную сумму (неустойку), размер которой может быть установлен в твердой сумме - штраф.
                <br>
                '''
        # Удаляем временный файл
        try:
            os.unlink(temp_path)
        except:
            pass
            
        return jsonify({
            "legalScore": legal_score,
            "economicScore": economic_score,
            "legalFactors": legalFactors,
            "economicFactors": economicFactors,
            "final" : final
        })

    except Exception as e:
        # Гарантированное удаление файла при ошибке
        if 'temp_path' in locals() and os.path.exists(temp_path):
            try:
                os.unlink(temp_path)
            except:
                pass
        return jsonify({"status": "error", "message": str(e)}), 500

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True, threaded=True)

